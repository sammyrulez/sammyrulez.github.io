<!DOCTYPE html>
<html lang="en">
<head>
        <title>"Forecasting Time Series from a COVID-19 Red Zone"</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="https://sammyrulez.github.io/theme/css/main.css" />
        <link href="https://sammyrulez.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Sam Reghenzi Homepage Full Atom Feed" />
</head>
<body>

    <div class="navigation pure-menu pure-menu-horizontal">
        <a href="https://sammyrulez.github.io/" class="pure-menu-heading  pure-menu-link">Sam Reghenzi Homepage</a>
        <ul class="pure-menu-list">
            <li class="pure-menu-item"></li>

            <li class="pure-menu-item pure-menu-selected"><a href="https://sammyrulez.github.io/category/misc.html" class="pure-menu-link">misc</a></li>
        </ul>
    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
<div class="pure-u-3-4 meta-data">
    <a href="https://sammyrulez.github.io/category/misc.html" class="category">misc</a><br />

    <a class="author" href="https://sammyrulez.github.io/author/sam-reghenzi.html">Sam Reghenzi</a>
    &mdash; <abbr title="2020-04-17T22:48:00+02:00">Fri 17 April 2020</abbr>
</div>        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>"Forecasting Time Series from a COVID-19 Red Zone"</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <ul>
<li>ML
category: blog
author: samreghenzi</li>
</ul>
<hr>
<p>Hello, dear citizen of the free world. I‚Äôm writing while I‚Äôm in a restricted lifestyle. On Monday night Italy‚Äôs prime minister decided that the entire country would be covered by restrictions that can be summarised as follows:</p>
<p>‚ÄúI stay at home‚Äù</p>
<p>All travel was banned unless justified on professional or health grounds. You can go out to buy food and medications and nothing else. You can‚Äôt visit your parents if they are in a different neighborhood. I‚Äôm working remotely 100% of the time and trying to survive with two kids with a lot of spare time üò∞.</p>
<p>The situation is serious just because the health care system is at its maximum capacity and lives of the elderly and other people with serious chronic afflictions are at stake. That said everything is fine: we have food and the sun shines as always in Italy.</p>
<p>So since I was already playing around with the Facebook Prophet library, I‚Äôm trying to put something together.</p>
<p>The government has been so efficient, beyond any expectation, to set up a Github repo with all the data cand even to update them daily!</p>
<p>I focus my effort on my province since there is less noise (regional and countrywide data could be misleading because the lockdown happened in different moments) and we are near the initial outbreak. And also I live here!</p>
<p>Disclaimer: This is more an exercise in building a time series pipeline rather than find significant data on when exactly this situation will end. I‚Äôm no epidemiologist. There are specific models for that and I‚Äôm purposely using one from a social network.</p>
<p>So the situation seems to flat out after 22 / 25 days.</p>
<p>So I clean up the data with pandas, filtered just the rows about my province and shape them to suit Prophet requirements</p>
<div class="highlight"><pre><span></span><code> <span class="n">bs</span><span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigla_provincia&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BS&#39;</span><span class="p">]</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;stato&#39;</span><span class="p">,</span> <span class="s1">&#39;codice_regione&#39;</span><span class="p">,</span> <span class="s1">&#39;denominazione_regione&#39;</span><span class="p">,</span><span class="s1">&#39;codice_provincia&#39;</span><span class="p">,</span><span class="s1">&#39;sigla_provincia&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;long&#39;</span><span class="p">,</span><span class="s1">&#39;denominazione_provincia&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
</code></pre></div>

<p>Then I run 50 days forecast on this data.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">m</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">forecast</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
</code></pre></div>

<p><a href="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KV-99lnw_6pKx9JcKDnBUw.png">image</a></p>
<p>That is suspicious: we had more cases than in China. I have more confidence with the Italian data, but since the curve is monotonously increasing the prediction will just follow. In the hope to make some sense in this forecast, I added a regressor that made some sense: the number of days since the lockdown in Italy. Sadly is the same day that the data started to be recorded so it does not add much information. So I added two seasonalities to model the expected peak after 25 days after the first case and another after 14 days when new infections are less than the healed ones.</p>
<div class="highlight"><pre><span></span><code>        <span class="n">m</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_regressor</span><span class="p">(</span><span class="s1">&#39;peak_reg&#39;</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_seasonality</span><span class="p">(</span><span class="s1">&#39;peak_period_start&#39;</span><span class="p">,</span><span class="n">period</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span><span class="n">fourier_order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_seasonality</span><span class="p">(</span><span class="s1">&#39;peak_period_end&#39;</span><span class="p">,</span><span class="n">period</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span><span class="n">fourier_order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
        <span class="n">future</span><span class="p">[</span><span class="s1">&#39;ds_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">future</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">])</span>
        <span class="n">future</span><span class="p">[</span><span class="s1">&#39;no_school&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">24</span><span class="p">))</span>
        <span class="n">future</span><span class="p">[</span><span class="s1">&#39;since_no_school&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span><span class="p">[</span><span class="s1">&#39;ds_ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">future</span><span class="p">[</span><span class="s1">&#39;no_school&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
        <span class="n">future</span><span class="p">[</span><span class="s1">&#39;peak_reg&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">future</span><span class="p">[</span><span class="s1">&#39;since_no_school&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">peak_days</span> <span class="p">)</span>
        <span class="n">forecast</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">image</span><span class="o">]</span><span class="p">(</span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">miro</span><span class="p">.</span><span class="n">medium</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="nl">resize</span><span class="p">:</span><span class="nl">fit</span><span class="p">:</span><span class="mi">1400</span><span class="o">/</span><span class="nf">format</span><span class="err">:</span><span class="n">webp</span><span class="o">/</span><span class="mi">1</span><span class="o">*</span><span class="n">uGUU8V4cwMeSz2IFWlr4yA</span><span class="p">.</span><span class="n">png</span><span class="p">)</span>

<span class="n">The</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">overfitting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">burst</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">last</span><span class="w"> </span><span class="n">few</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">small</span><span class="p">.</span><span class="w"> </span><span class="n">So</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">8</span><span class="n">K</span><span class="w"> </span><span class="n">infected</span><span class="w"> </span><span class="n">predicted</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">peak</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">exaggerated</span><span class="w"> </span><span class="n">estimation</span><span class="p">.</span><span class="w"> </span><span class="n">But</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dates</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">estimated</span><span class="w"> </span><span class="nc">time</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">peak</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">epidemiologist</span><span class="w"> </span><span class="n">model</span><span class="err">!</span><span class="w"> </span><span class="n">I</span><span class="err">‚Äô</span><span class="n">m</span><span class="w"> </span><span class="n">going</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">every</span><span class="w"> </span><span class="nf">day</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">enhance</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">estimations</span><span class="p">.</span><span class="w"> </span><span class="n">Worst</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nl">scenario</span><span class="p">:</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">second</span><span class="w"> </span><span class="nf">day</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">higher</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">peak</span><span class="w"> </span><span class="n">ha</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">reached</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">learned</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">Facebook</span><span class="w"> </span><span class="n">Prophet</span><span class="p">.</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nl">scenario</span><span class="p">:</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">predict</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">lockdown</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">office</span><span class="p">.</span>
</code></pre></div>
    </div>

    <footer>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="https://sammyrulez.github.io/author/sam-reghenzi.html">Sam Reghenzi</a></h3>
                        <p class="author-description">
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>


</div>



    <footer class="index-footer">

        <a href="https://sammyrulez.github.io/" title="Sam Reghenzi Homepage">Sam Reghenzi Homepage</a>
        <a href="https://sammyrulez.github.io/category/misc.html">misc</a>
        <a href="https://getpelican.com/">Pelican</a>
        <a href="https://www.python.org/">Python.org</a>
        <a href="https://palletsprojects.com/p/jinja/">Jinja2</a>
        <a href="#">You can modify those links in your config file</a>

    </footer>

</body>
</html>